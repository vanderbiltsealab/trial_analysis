---
title: "R Notebook"
output: html_notebook
---

----------------------------------

All family members loops with child

-----------------------------------


```{r}
m <- inner_join(s_z, z_s, by = 'timestamp')
m <- m %>% filter(distance.x == distance.y)
m <- m %>% select(timestamp, device.x, device.y, motion.x, motion.y, other_device.x, other_device.y, distance_m.x, time.x)
m <-m %>% rename(time = time.x, distance = distance_m.x )
m <- reshape(m, idvar = "timestamp", timevar = "device.y", direction = "wide")
```



```{r}
n <- inner_join(s_v, v_s, by = 'timestamp')
n <- n %>% filter(distance.x == distance.y)
n <- n %>% select(timestamp, device.x, device.y, motion.x, motion.y, other_device.x, other_device.y, distance_m.x, time.x)
n <- n %>% rename(time = time.x, distance = distance_m.x )
n <- reshape(n, idvar = "timestamp", timevar = "device.y", direction = "wide")
```

```{r}
mn <-inner_join(m,n, by = 'timestamp') %>% 
  select(-c('timestamp', starts_with('other_device'), 'time.c0:98:e5:42:01:07', 'device.x.c0:98:e5:42:01:07', 'motion.x.c0:98:e5:42:01:07'))
mn <- mn %>% rename(time = 'time.c0:98:e5:42:01:06', motion_03 = 'motion.x.c0:98:e5:42:01:06', motion_06 = 'motion.y.c0:98:e5:42:01:06', motion_07 = 'motion.y.c0:98:e5:42:01:07', device = 'device.x.c0:98:e5:42:01:06', distance_06 = 'distance.c0:98:e5:42:01:06', distance_07 = 'distance.c0:98:e5:42:01:07')

```

```{r}
for(i in 1:nrow(mn)) {
  if ((mn$distance_06[i] >= 1) & (mn$distance_07[i] >= 1)) {
    mn[i,'yn'] <- 1
  }
  else{
    mn[i,'yn'] <- 0
  }
}

```


```{r}
mn$sum <- rollapply(mn$yn,3,sum, partial = TRUE, align = "right")
```


```{r}

for(i in 1:nrow(mn)) {
  if ((mn$sum[i] == 2) && (mn$sum[i-1] == 3)) {
    mn[i,'loop'] <- 1
  }
  else{
    mn[i,'loop'] <- 0 
  }
}


for(i in 1:nrow(mn)) {
  if ((mn$loop[i] == 1) && (mn$yn[i+1] == 1)) {
    mn[i,'loop'] <- 0
  }
}
```

```{r}
sum(mn$loop)
```




**don't think the below works -- ignore for now




```{r}
#df$other_name <- ifelse(df$other_device == 'c0:98:e5:42:01:06', 'Zeke',ifelse(df$other_device == 'c0:98:e5:42:01:03', 'Sid','Virginia'))
```

```{r}
df$status <- ifelse(df$device == 'c0:98:e5:42:01:06' | df$device == 'c0:98:e5:42:01:07', 'parent', 'child')
```

```{r}
for(i in 1:nrow(df)) {
  if (df$distance_m[i] >= 1) {
    df[i,'yn'] <- 1
  }
  else{
    df[i,'yn'] <- 0 
  }
}
```


```{r}
df_all <- df %>% group_by(device, other_device) %>%
       mutate(sum=rollapplyr(yn, 3, sum, partial=TRUE))
```

```{r}
for(i in 1:nrow(df_all)) {
  if ((df_all$sum[i] == 2) && (df_all$sum[i-2] == 3)) {
    df_all[i,'loop'] <- 1
  }
  else{
    df_all[i,'loop'] <- 0 
  }
}

for(i in 1:nrow(df_all)) {
  if ((df_all$loop[i] == 1) && (df_all$yn[i+2] == 1)) {
    df_all[i,'loop'] <- 0
  }
}
```

```{r}
sum(df_all$loop)
```


```{r}
library(dplyr)
wide <- reshape(df, idvar = "time_stamp", timevar = "name", direction = "wide") 
wide %>% select(starts_with("other"), starts_with("distance_m"))

```

```{r}
df%>% reshape(idvar = "time_stamp", timevar = "name", direction = "wide") 
```




**thinking through loop initiation and closing (arrivals and departures)

```{r}
for(i in 1:nrow(mn)){
  if(mn$loop == 1){
    if()
  }
}
```



```{r}
mn %>% filter(loop == 1) %>% mutate(
    touching = case_when(
      (distance_06 < 1 & distance_07 < 1) ~ "both",
      distance_07 < 1 ~ "07",
      distance_06 < 1 ~ "06"
    ))
```

```{r}
mn <- mn %>% mutate(
  touching = case_when(
  grepl(1, loop) & (distance_06 < 1 & distance_07 < 1) ~ "both",
  grepl(1, loop) & distance_07 < 1 ~ "07",
  grepl(1, loop) & distance_06 < 1 ~ "06",
  grepl(0, loop) ~ "N/A"))

mn %>% count(touching)
```

